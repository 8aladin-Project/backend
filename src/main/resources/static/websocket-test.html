<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket + FCM ì•Œë¦¼ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-connect {
            background-color: #4CAF50;
            color: white;
        }
        .btn-connect:hover {
            background-color: #45a049;
        }
        .btn-disconnect {
            background-color: #f44336;
            color: white;
        }
        .btn-disconnect:hover {
            background-color: #da190b;
        }
        .btn-action {
            background-color: #2196F3;
            color: white;
        }
        .btn-action:hover {
            background-color: #0b7dda;
        }
        #messages {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #1e1e1e;
            color: #d4d4d4;
            resize: vertical;
            box-sizing: border-box;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
        .info-box h3 {
            margin-top: 0;
            color: #1976D2;
        }
        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info-box li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ WebSocket + FCM ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ ì‚¬ìš© ë°©ë²•</h3>
            <ul>
                <li>1. Member IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (íšŒì› ID)</li>
                <li>2. ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                <li>3. "ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ WebSocket ì—°ê²°</li>
                <li>4. "êµ¬ë…" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì±„íŒ…ë°© êµ¬ë…</li>
                <li>5. "ë©”ì‹œì§€ ì „ì†¡" ë²„íŠ¼ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸</li>
                <li>6. ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì˜¤í”„ë¼ì¸ì´ë©´ FCM ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤</li>
            </ul>
        </div>

        <div id="status" class="status status-disconnected">
            ìƒíƒœ: ì—°ê²° ì•ˆ ë¨
        </div>

        <div class="section">
            <label>Member ID:</label>
            <input type="number" id="memberId" value="1" placeholder="íšŒì› IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <div class="section">
            <label>Room ID:</label>
            <input type="number" id="roomId" value="1" />
        </div>

        <div class="section">
            <button class="btn-connect" onclick="connect()">ğŸ”Œ ì—°ê²°</button>
            <button class="btn-disconnect" onclick="disconnect()">âŒ ì—°ê²° í•´ì œ</button>
            <button class="btn-action" onclick="subscribe()">ğŸ“¡ êµ¬ë…</button>
            <button class="btn-action" onclick="unsubscribe()">ğŸ“´ êµ¬ë… í•´ì œ</button>
            <button class="btn-action" onclick="sendMessage()">ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡</button>
            <button class="btn-action" onclick="checkConnection()">ğŸ” ì—°ê²° ìƒíƒœ í™•ì¸</button>
        </div>

        <div class="section">
            <label>ë©”ì‹œì§€ ë¡œê·¸:</label>
            <textarea id="messages" readonly></textarea>
        </div>
    </div>

    <script>
        let stompClient = null;
        let subscription = null;

        function addMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const emoji = {
                'success': 'âœ…',
                'error': 'âŒ',
                'info': 'â„¹ï¸',
                'warning': 'âš ï¸',
                'send': 'ğŸ“¤',
                'receive': 'ğŸ“¨',
                'connect': 'ğŸ”Œ',
                'disconnect': 'ğŸ”Œ'
            }[type] || 'â„¹ï¸';
            
            messagesDiv.value += `[${timestamp}] ${emoji} ${message}\n`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.className = 'status status-connected';
                statusDiv.textContent = 'ìƒíƒœ: ì—°ê²°ë¨ âœ…';
            } else {
                statusDiv.className = 'status status-disconnected';
                statusDiv.textContent = 'ìƒíƒœ: ì—°ê²° ì•ˆ ë¨ âŒ';
            }
        }

        function connect() {
            const memberId = document.getElementById('memberId').value.trim();
            
            if (!memberId) {
                alert('Member IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            addMessage('WebSocket ì—°ê²° ì‹œë„ ì¤‘...', 'info');
            
            // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ memberId ì „ë‹¬
            const wsUrl = 'http://localhost:8080/ws-chat?memberId=' + encodeURIComponent(memberId);
            const socket = new SockJS(wsUrl);
            
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                connectHeaders: {},
                debug: function(str) {
                    console.log('STOMP Debug:', str);
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
            });

            stompClient.onConnect = function(frame) {
                console.log('Connected:', frame);
                addMessage('WebSocket ì—°ê²° ì„±ê³µ!', 'success');
                addMessage(`ì„œë²„ ì‘ë‹µ: ${JSON.stringify(frame.headers, null, 2)}`, 'info');
                updateStatus(true);
            };

            stompClient.onDisconnect = function() {
                console.log('Disconnected');
                addMessage('WebSocket ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'disconnect');
                updateStatus(false);
            };

            stompClient.onStompError = function(frame) {
                console.error('STOMP Error:', frame);
                const errorMsg = frame.headers['message'] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                const errorDetails = frame.body || '';
                addMessage(`ì—°ê²° ì‹¤íŒ¨: ${errorMsg}`, 'error');
                if (errorDetails) {
                    addMessage(`ìƒì„¸: ${errorDetails}`, 'error');
                }
                updateStatus(false);
            };

            stompClient.onWebSocketError = function(error) {
                console.error('WebSocket Error:', error);
                addMessage(`WebSocket ì˜¤ë¥˜: ${error.message || error}`, 'error');
                updateStatus(false);
            };

            stompClient.activate();
        }

        function disconnect() {
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
                addMessage('ì±„íŒ…ë°© êµ¬ë… í•´ì œë¨', 'disconnect');
            }
            
            if (stompClient !== null) {
                stompClient.deactivate();
                addMessage('WebSocket ì—°ê²° í•´ì œë¨', 'disconnect');
                updateStatus(false);
            }
        }

        function subscribe() {
            if (stompClient === null || !stompClient.connected) {
                addMessage('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”!', 'error');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            
            if (!roomId) {
                addMessage('ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!', 'error');
                return;
            }

            const destination = '/topic/chat/' + roomId;
            
            if (subscription) {
                addMessage('ì´ì „ êµ¬ë…ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ êµ¬ë…í•©ë‹ˆë‹¤.', 'warning');
                subscription.unsubscribe();
                subscription = null;
            }

            subscription = stompClient.subscribe(destination, function(message) {
                try {
                    const body = JSON.parse(message.body);
                    addMessage(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${JSON.stringify(body, null, 2)}`, 'receive');
                } catch (e) {
                    addMessage(`ë©”ì‹œì§€ ìˆ˜ì‹  (íŒŒì‹± ì‹¤íŒ¨): ${message.body}`, 'receive');
                }
            });
            
            addMessage(`ì±„íŒ…ë°© êµ¬ë… ì™„ë£Œ: ${destination}`, 'success');
        }

        function unsubscribe() {
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
                addMessage('ì±„íŒ…ë°© êµ¬ë… í•´ì œë¨', 'disconnect');
            } else {
                addMessage('êµ¬ë… ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            }
        }

        function sendMessage() {
            if (stompClient === null || !stompClient.connected) {
                addMessage('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”!', 'error');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            const memberId = document.getElementById('memberId').value;
            
            if (!roomId || !memberId) {
                addMessage('ì±„íŒ…ë°© IDì™€ Member IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!', 'error');
                return;
            }

            const content = prompt('ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (!content || content.trim() === '') {
                addMessage('ë©”ì‹œì§€ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            const message = {
                senderId: parseInt(memberId),
                content: content.trim()
            };
            
            const destination = '/app/api/v1/chat/' + roomId;
            
            try {
                stompClient.publish({
                    destination: destination,
                    body: JSON.stringify(message)
                });
                
                addMessage(`ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ: "${content}"`, 'send');
                addMessage(`ì „ì†¡ ê²½ë¡œ: ${destination}`, 'info');
                addMessage(`ì „ì†¡ ë°ì´í„°: ${JSON.stringify(message, null, 2)}`, 'info');
            } catch (error) {
                addMessage(`ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        function checkConnection() {
            if (stompClient === null) {
                addMessage('STOMP í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            if (stompClient.connected) {
                addMessage('âœ… ì—°ê²° ìƒíƒœ: ì—°ê²°ë¨', 'success');
                addMessage(`ì„œë²„: ${stompClient.ws ? 'WebSocket ì—°ê²°ë¨' : 'WebSocket ì—°ê²° ì•ˆ ë¨'}`, 'info');
                
                if (subscription) {
                    addMessage('âœ… êµ¬ë… ìƒíƒœ: êµ¬ë… ì¤‘', 'success');
                } else {
                    addMessage('âš ï¸ êµ¬ë… ìƒíƒœ: êµ¬ë… ì•ˆ í•¨', 'warning');
                }
            } else {
                addMessage('âŒ ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆ ë¨', 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
        window.onload = function() {
            addMessage('=== WebSocket í…ŒìŠ¤íŠ¸ ë„êµ¬ ì‹œì‘ ===', 'info');
            addMessage('1. JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”', 'info');
            addMessage('2. "ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'info');
            addMessage('3. "êµ¬ë…" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì±„íŒ…ë°© êµ¬ë…', 'info');
            addMessage('4. "ë©”ì‹œì§€ ì „ì†¡" ë²„íŠ¼ìœ¼ë¡œ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸', 'info');
        };
    </script>
</body>
</html>

